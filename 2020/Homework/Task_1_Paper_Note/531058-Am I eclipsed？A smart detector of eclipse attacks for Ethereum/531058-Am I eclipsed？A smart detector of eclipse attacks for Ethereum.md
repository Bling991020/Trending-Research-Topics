# 基于随机森林的eclipse攻击检测模型

- 原文标题：Am I eclipsed? A smart detector of eclipse attacks for Ethereum


- 原文作者：Guangquan Xu; Bingjiang Guo; Chunhua Su; Xi Zheng; Kaitai Liang; Duncan S. Wong; Hao Wang;


- 原文来源：《Computers & Security, 2020 Volume 88》https://www.sciencedirect.com/science/article/pii/S0167404818313798?via%3Dihub


- 笔记作者：简欣娅-2018141531058




## 论文概述

### 研究背景

由于区块链部署在分布式和分散的网络中，区块链应用程序可能容易受到各种类型的网络攻击，本文讨论的“Eclipse攻击”就是其中一种，Eclipse攻击能够使恶意攻击者通过控制所有的传输连接来隔离系统用户。过去的研究表明，区块链的安全性依赖于其底层对等网络的安全性。如果对等网络已分区，并且其节点具有有关分类账的信息的不同副本，则这些节点将不会在网络上的唯一分类账上达成任何协议。在攻击中，攻击者可以完全控制其目标对其他网络节点的访问，从而使攻击者能够阻止目标的分类账视图，甚至进一步使用目标的计算资源进行更复杂的攻击。Eclipse攻击可以用作对区块链平台的其他攻击的有用构建块。

### 研究结果

本文中提出了一种基于机器学习技术的检测模型，以保护以太网络客户端免受Eclipse攻击。当攻击者试图覆盖所有节点时，需要向目标发送持续的连接请求。来自攻击者过多的未经请求的传入连接将占据到该节点的所有传入连接，这导致诚实节点无法从其他节点接收当前分类帐的信息的结果。除了这个攻击模式之外，攻击者还可以使用精心设计的节点标识符集将ping重复发送到目标，这些标识符可以填充目标的表，即路由表。本文中发现这两种攻击方法都可能泄漏信息以供我们跟踪攻击。基于Marcus等人定义的Eclipse攻击，作者提出了一种更加普遍和实用的Eclipse攻击模型 。该模型可以检查目标的状态在完整的Eclipse攻击过程中如何变化。正常数据包和攻击数据包可以根据攻击状态的变化进行收集，并且进一步由机器学习算法获取，以进行检测分析。我们选择目标接收的数据包的几种功能，然后训练一个检测模型以识别新数据包的类型。



## 论文主要内容

### Ethereum P2P network

网络中的对等方由nodeID标识，该ID是512位ECDSA加密公钥。利用计算机启动具有不同nodeID的多个以太坊节点很容易。对于一个节点，通常需要执行的是运行ECDSA密钥生成算法。但是，该算法将不会检查nodeID是否对应于唯一的网络地址。因此，理论上可以在具有相同IP地址的多台机器上运行无限数量的节点。

在点对点网络连接中，UDP用于查找其他对等点，并进一步建立连接通道以交换分类帐信息。所有分类帐信息都是通过加密并经过身份验证的TCP连接传输的。UDP连接最多可同时建立16个，并且UDP连接的总数不受限制。TCP连接的限制是Maxpeers，默认情况下设置为25。有2组UDP消息。ping消息请求pong返回消息。这对消息用于检查邻居节点是否处于活动状态。一个findnode消息请求邻居消息，其中包含响应节点已找到的16个节点的列表。仅当查询节点已经在其db中时，该节点才会响应findnode请求，这是一种网络信息存储。要通过垄断连接使节点不能发挥作用，攻击者必须反复占据受害者TCP连接的所有Maxpeers。仅当客户端在开始时允许/设置TCP连接时，TCP连接才可以传出。否则，它将默认设置为传入连接。传出TCP连接最多可以启动![image-20200428163607124](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428163607124.png)与客户的其他同行。但是，在Geth v1.8之前，除了Maxpeers之外，对未经请求的传入TCP连接的数量没有限制。这意味着节点的TCP连接的Maxpeers都可以是未经请求的传入连接。

邻居节点的信息存储在两个数据结构中。db是存储节点的信息，一个客户端已被键合的长期数据库。如果节点在收到ping消息后返回有效且相应的pong响应，则它将被绑定。db的大小没有限制。每个数据库条目包括一个节点ID，IP地址，TCP端口，UDP端口，从该节点发送的最后一次ping的时间，在该节点上收到的最后一个pong的时间以及该节点无法响应findnode的次数。

该表中有256个存储桶，其中每个存储桶由条目。它说明了网络信息存储。每个条目存储Ethereum节点信息，包括nodeID，IP地址，TCP端口和UDP端口。将新节点添加到存储桶后，它通过logdist函数进行映射，该函数是对Kademlia协议中XOR指标的修改。该logdist功能用于测量两个nodeIDs之间的距离。![图。1](https://ars.els-cdn.com/content/image/1-s2.0-S0167404818313798-gr1.jpg)

### 构建eclipse攻击模型

通过上节的分析，作者认为要使节点失去作用，攻击者必须填充受害者的db，这使得受害者只能通过攻击者的节点获取信息，攻击方法如下：

1. Bonding

   首先，攻击者需要填充目标的数据库和路由表。节点绑定之前客户端会先进行一系列的检查，价差通过后客户端将节点添加到table中，同时更新db

2. Unsolicited pings

   客户端从其他节点接收到未经请求的ping，用pong消息响应，然后进一步成功绑定到该节点。

3. Lookup

   迭代查找方法可用于客户端发现新节点。客户端将包含目标节点t的findnode发送到表中最接近的16个节点。接收节点findnode将查询其表，并在最近发送16个节点表到其发送者。因此，客户具有256个节点。

4. #### Selecting connection peers

   客户端启动时，任务运行器将被启动并连续运行。任务运行器最多可以创建与以太坊网络中其他节点的传出TCP连接。通常，从look_up中选择一半外向TCP连接对等方，从其table中选择另一半。该random_buffer可容纳节点。在task_creation阶段，客户端节点从表中随机选择对等方以填充random_buffer。

一般来说，有两种方法可以在以太坊网络上发起日食攻击。一种是攻击者通过在客户端要建立任何传出的TCP连接之前建立到其自身的恶意节点的Maxpeers传入TCP连接来入侵受害者，另一种是通过拥有该表而使Ethereum受害者不能使用网络。重新启动时，受害人很可能会占据其与自己的对抗节点的所有十三条传出连接。攻击者立即用未经请求的传入连接垄断了受害者的其余连接。基于攻击方法，从受害者的角度作者设计了日食攻击的框架。在框架中为节点定义了4个状态，通过状态的变化，可以知道节点在那时是否正遭受日食攻击。

1. Running

   表示该节点已经持续了至少24小时，并且已建立对等连接。节点的数据库*db*和*table*可能具有一些对等信息。*db*包含以*pong*消息响应来自客户端的*ping*消息的节点。

2. Reborn

   由于某种原因（例如崩溃和恢复）重启节点后，它将变为重生状态。重新引导后，该表始终为空。这为攻击者提供了一个以节点攻击窗口的方式，使得受害者重新启动后，攻击者立即启动到受害者的传入连接或精心制作的数据包。

3. Submerge

   攻击者建立了受害者的Maxpeers传入TCP连接到其自己的对抗节点，强制将受害者的所有连接设置为传入连接。

4. Poisoned

   受害者的表被攻击者插入精心设计的nodeID。受害者在这里很可能形成与攻击者节点的所有传出连接。

![image-20200428171548646](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428171548646.png)

### 基于随机森林分类的检测模型

要垄断或毒害节点，攻击者必须向受害者发送持续的连接请求。为了扮演受害者的角色，可以收集来自非请求节点的所有UDP数据包。根据收到的请求顺序判断资源是否真实。在分析数据包的日食攻击数据时，我们发现它具有两个“多对一”功能：1）数据流的源地址和目标地址具有多对一关系，2）数据流的源地址与目标端口具有多对一关系。当攻击目标主机的服务时，攻击者会将大量数据流发送到目标主机的固定端口

训练检测模型的过程如图所示。首先，从训练UDP数据包中提取特征向量。接下来，使用训练数据集训练随机森林分类器，该数据集结合了特征向量及其对应的标签。最后，使用新的UDP数据包测试模型。为此，执行与训练数据集相同的特征提取过程，并馈入特征向量以进行最终预测。将这些预测用作预期的标签。

![image-20200428172023189](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428172023189.png)

#### 分类特征

从特征中，作者定义了可以直接从数据包中计算出的数据项，并帮助识别日食攻击：

1. *packets_size*代表访问数据包的大小。普通访问数据包和攻击数据包之间的主要区别在于，后者的pingpong数量比findnode-neighbor数量多得多。并且这两种UDP数据包的大小也不同。根据以上证据，我们可以确定攻击数据的特征。
2. access_frequencies表示节点访问频率。为了使受害者透明，攻击者需要反复发送ping请求。繁忙的交流可以用作检查日食攻击的功能之一
3. access_time表示连接时间。当一个节点无法连接到对方，发件人可能立即取消该连接。相反，对于攻击情形，攻击者宁愿等到答复而不是轻易放弃。

#### 随机森林模型

随机森林以决策树为分类器进行训练，而无需进行Bagging算法的后备采样。同时，随机子空间算法仅采用训练集中的部分样本进行训练，其结果由决策树投票确定。在随机森林中，每个分类树都是遵循递归划分原理的二叉树。二叉树从根节点开始依次划分训练集，它的产生遵循自上而下的原则。包含所有训练数据的根节点根据最小纯度的原则分为左节点和右节点，并且它包含训练数据的子集。节点继续根据相同规则进行拆分，并在满足分支停止规则时停止增长。

算法的实现设计如下。
（1）为了初始化数据集，用Bootstrap方法用于每次从数据集中随机提取k个样本集，以生成k个分类树。

（2）从k个分类树中的每棵树的节点中随机获得S个变量（。从这些变量中选择最具代表性的变量。分类的阈值由多个分类点确定。

（3）不要修剪分类树木以使其无限期生长。

（4）通过构造随机森林将新样本划分为随机森林，并通过分类器投票确定分类结果。

#### RFC模型训练

通过计算到达Ω节点的训练样本集，获得分类标准h（x，θ）∈{0，1}。在这里，我们让X  ∈  [R 米代表训练样本，θ  ∈{ φ，ψ }是该弱分类器的参数，φ（ψ）是过滤器功能，ψ是一个列向量参数或矩阵参数，和θ确定弱分类器的分类超平面的模式。

![image-20200428173935194](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428173935194.png)

![image-20200428173923317](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428173923317.png)

![image-20200428173826672](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428173826672.png)

RFC模型训练过程如下。在模型训练过程中，训练*n个*决策树。首先通过使用函数从训练集*T中*重新采样*p个*样本来获得样本集*T* '，然后获得特征集*Att*。其次，我们从特征集中*Att*采样了*k个*特征而不进行替换。而T'“保持*ATT* '包含的功能。最终，我们可以构建数组*DT*。

#### RFC模型分类

x属于c的概率：![image-20200428174157352](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428174157352.png)

x类别的决策：![image-20200428174220816](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428174220816.png)

模型分类过程如下：

![image-20200428174317273](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428174317273.png)

### 攻击检测模型的实验表现

1. 数据收集

   首先在*运行*状态下收集正常的访问连接数据包，然后使用攻击脚本尝试通过重复发送*ping*来攻击。在受害者重新启动之前，开始收集日食攻击数据包，直到其进入的连接被我们占用或它的*表*被节点条目填满为止。在这一步，利用*wireshark*收集受害者的UDP数据包。

2. 数据预处理

   收集的数据类型有 *ping, pong, findnode* and neighbors

   所有数据包均使用ECDSA-secp256k1密钥（代表节点ID）签名。

   所有数据包都以数据包基础数据的SHA3-256哈希值开头。

   数据包类型：单字节<2 ** 7 //有效值在[1，4]中。

   完整的UDP数据包有效负载：哈希|| 签名|| 包类型|| 数据包数据

3. 训练模型

   正常的和恶意攻击的分组具有不同的大小分布的分组。要使正常节点透明，攻击者必须向受害者发送许多ping请求。与findnode，neighbors类型的数据包相比，ping，pong类型的数据包将具有较少的数据信息。因此，它们的大小具有不同的分布。

   ![image-20200428175013927](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428175013927.png)

   攻击访问消耗了更高的时间复杂度。这表明为短连接建立了正常访问。如果受害人无法按时向攻击者打*乒乓球*，则攻击者可以等待更长的时间。

   ![image-20200428175032863](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428175032863.png)

   当一个节点遭受日食攻击时，存在更高的访问频率。因为，为了使受害者透明，必须将*ping*请求重复发送给受害者。繁忙的交流可被视为日食攻击的迹象。

   ![image-20200428175043761](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428175043761.png)

4. 检测

   作者的输入是已根据统计分布处理的UDP数据。检测模型是使用sklearn构建的，并且在步骤1中以3：7的比率从测试数据中分离出测试数据。当从对抗节点接收到许多新的UDP连接时，节点将重新启动。检测可以识别出极有可能发动了日食攻击的对手连接请求。

   通过随机森林分类，检测的准确率和召回率分别为72％和93％，在实践中相对较高。实验结果表明，大约三分之一的已检查攻击数据可以击中其地面标签。同时，可以正确识别所有恶意数据的90％以上，这意味着作者的检测模型可以阻止大多数攻击数据包。

   ![image-20200428175346100](C:\Users\20181\AppData\Roaming\Typora\typora-user-images\image-20200428175346100.png)



### 总结

为了保护Ethereum节点不受eclipse攻击，作者定义了攻击连接流的特征，并进一步提出了一种基于随机森林算法的eclipse攻击检测模型。具体来说，已经定义了eclipse攻击过程中的状态更改。作者的检测模型利用模型的融合上下文和流量增长的拟合度的稳定性来检测恶意连接请求。UDP的四种类型的数据包的特征，即packets_size, access_frequency和access_time。仿真结果表明，该模型具有较高的检测率和较低的误报率，能较准确地区分正常流量和攻击流量。

## 论文创新点

作者这篇论文主要解决的问题是对于日食攻击的检测识别。作者从攻击者的角度出发，从攻击方法流程，攻击者行为分析甚至心理分析角度切入，提取出攻击特征，并用数据来描述和标记这些特征，从而达到一个较为高的识别准确率。作者根据客户端的行为自定义了用于识别的状态，能够帮助我们的理解以及探测模型的建立。自设计的攻击模型贴合现实攻击特点，并且作者找到了一种比较合理的分析模型，从而使实验更让人信服。

其次，我认为作者在研究思路方面逻辑清晰，行文结构严谨，没有太大的逻辑问题。作者的标题起得也很好，这是一个问句加名词结构的标题，前者能够吸引眼球，后者则主要突出了本文的研究重点，

## 论文目前缺点

首先，本文对于日食攻击的背景和危害铺垫稍显冗长。其次，作者也在相关工作中说到，日食攻击在区块链领域目前来说还是比较新的攻击，对于该攻击的研究还不深入，作者在这方面的研究也稍显浅薄，有一些研究手法过于片面比如只使用UDP数据报，对于算法的使用也缺少对比性，可能需要更多人的研究加入来佐证作者的实验结果。
